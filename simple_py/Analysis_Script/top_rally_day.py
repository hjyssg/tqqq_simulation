"""
本文件用于分析股票指数历史数据，找出历史上最大的前二十个单日涨幅（按百分比计算）。
"""

import pandas as pd
import os
import sys
import matplotlib.pyplot as plt

# 将util.py所在的目录添加到系统路径中
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
import _util

# 读取数据
data = _util.load_csv_as_dataframe("^SPX.csv")  # data is dataframe

# 确保按日期排序
data['Date'] = pd.to_datetime(data['Date'])
data.sort_values('Date', inplace=True)

# 计算每日的百分比变化（相对于前一天的Close）
data['Pct_Change'] = data['Close'].pct_change()

# 找出涨幅最大的20天（涨幅为负，所以按升序取前20）
top20_drops = data.nlargest(20, 'Pct_Change')

# 输出结果
print("历史上最大的前二十单日涨幅：")
print(top20_drops[['Date', 'Close', 'Pct_Change']])


# 历史上最大的前二十单日涨幅：
#                            Date       Close  Pct_Change
#  1933-03-15 00:00:00+00:00    6.810000    0.166096
#  1929-10-30 00:00:00+00:00   22.990000    0.125306
#  1931-10-06 00:00:00+00:00    9.910000    0.123583
#  1939-09-05 00:00:00+00:00   12.640000    0.118584
#  1932-09-21 00:00:00+00:00    8.520000    0.118110
#  1962-05-31 00:00:00+00:00   58.799999    0.106719
#  1931-06-22 00:00:00+00:00   14.610000    0.105144
#  1935-04-17 00:00:00+00:00    9.010000    0.096107
#  1933-04-20 00:00:00+00:00    7.820000    0.095238
#  1987-10-21 00:00:00+00:00  236.830002    0.094105
#  1935-05-17 00:00:00+00:00   10.010000    0.093989
#  1932-08-08 00:00:00+00:00    7.430000    0.092647
#  2008-10-29 00:00:00+00:00  922.260010    0.091083
#  1929-11-14 00:00:00+00:00   19.240000    0.089468
#  1933-06-19 00:00:00+00:00   10.680000    0.088685
#  1932-08-03 00:00:00+00:00    6.390000    0.088586
#  1933-07-24 00:00:00+00:00   10.500000    0.088083
#  2008-10-13 00:00:00+00:00  912.750000    0.086866
#  1931-10-08 00:00:00+00:00   10.620000    0.085890
#  1931-12-18 00:00:00+00:00    8.360000    0.082902